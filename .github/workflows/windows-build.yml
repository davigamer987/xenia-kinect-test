name: Windows Build

on:
  workflow_dispatch:

jobs:
  build-windows-release:
    name: Build xenia-app (Release)
    runs-on: windows-2022
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Run setup
        shell: pwsh
        run: py -3 .\xenia-build setup

      - name: Build xenia-app (Release)
        shell: pwsh
        run: |
          $buildArgs = @(
            '.\xenia-build',
            'build',
            '--config', 'release',
            '-j', $env:NUMBER_OF_PROCESSORS,
            '--',
            '/v:minimal',
            '/clp:ErrorsOnly;Summary',
            '/bl:msbuild.binlog'
          )

          & py -3 @buildArgs 2>&1 | Tee-Object -FilePath xenia-build.log
          $exitCode = $LASTEXITCODE

          if ($exitCode -ne 0) {
            Write-Host "=== Extracted error lines ==="
            $errors = Select-String `
              -Path xenia-build.log `
              -Pattern 'error MSB|fatal error|: error [A-Z]*[0-9]+' `
              -CaseSensitive:$false
            if ($errors) {
              $errors | Select-Object -First 200 | ForEach-Object { $_.Line }
            } else {
              Write-Host "No explicit error lines were matched; inspect msbuild.binlog."
            }
          }

          exit $exitCode

      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xenia-windows-build-log
          path: xenia-build.log
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload MSBuild binlog
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xenia-windows-msbuild-binlog
          path: msbuild.binlog
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload Release binaries
        uses: actions/upload-artifact@v4
        with:
          name: xenia-windows-release
          path: build/bin/Windows/Release/**
          if-no-files-found: error
          retention-days: 14
